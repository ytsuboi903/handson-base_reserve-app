name: Deploy to OpenShift

on:
  push:
    branches:
      - main
      - sandbox
      - 'team*-sandbox'
      - 'team*'
  workflow_dispatch:

env:
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Build backend
      working-directory: ./backend
      run: mvn clean package -DskipTests

    - name: Build frontend
      working-directory: ./frontend
      run: |
        # npm ciのバグでオプショナル依存関係がインストールされない場合があるため、
        # npm install --forceを使用（package.jsonに@rollup/rollup-linux-x64-gnuをoptionalDependenciesとして追加済み）
        npm install --force
        npm run build

    - name: Install OpenShift CLI
      run: |
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | tar -xz
        sudo mv oc kubectl /usr/local/bin/

    - name: Extract team identifier
      id: team
      run: |
        BRANCH_NAME="${{ github.ref_name }}"
        echo "Branch name: $BRANCH_NAME"
        
        # ブランチ名からチーム識別子を抽出
        if [[ "$BRANCH_NAME" == "sandbox" ]] || [[ "$BRANCH_NAME" == "main" ]]; then
          TEAM_ID="default"
        elif [[ "$BRANCH_NAME" =~ ^team([0-9]+)(-.*)?$ ]]; then
          # team1-sandbox または team1 から team1 を抽出
          TEAM_ID="team${BASH_REMATCH[1]}"
        else
          # その他のブランチ名から最初の部分を抽出（ハイフン区切り）
          TEAM_ID=$(echo "$BRANCH_NAME" | cut -d'-' -f1 | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
          if [ -z "$TEAM_ID" ]; then
            TEAM_ID="default"
          fi
        fi
        
        # OpenShiftプロジェクト名は小文字とハイフンのみ許可
        TEAM_ID=$(echo "$TEAM_ID" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
        
        # プロジェクト名を生成（最大63文字、小文字、数字、ハイフンのみ）
        # booking- は8文字なので、TEAM_IDは最大55文字まで
        MAX_TEAM_ID_LENGTH=55
        if [ ${#TEAM_ID} -gt $MAX_TEAM_ID_LENGTH ]; then
          TEAM_ID="${TEAM_ID:0:$MAX_TEAM_ID_LENGTH}"
        fi
        PROJECT_NAME="booking-${TEAM_ID}"
        
        echo "team_id=$TEAM_ID" >> $GITHUB_OUTPUT
        echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "Team ID: $TEAM_ID"
        echo "Project Name: $PROJECT_NAME"

    - name: Login to OpenShift
      run: |
        oc login --server=${{ env.OPENSHIFT_SERVER }} --token=${{ env.OPENSHIFT_TOKEN }} --insecure-skip-tls-verify=true

    - name: Create or select project
      run: |
        PROJECT_NAME="${{ steps.team.outputs.project_name }}"
        if oc get project "$PROJECT_NAME" > /dev/null 2>&1; then
          oc project "$PROJECT_NAME"
        else
          oc new-project "$PROJECT_NAME"
        fi

    - name: Generate OpenShift configurations
      run: |
        PROJECT_NAME="${{ steps.team.outputs.project_name }}"
        
        # 一時ディレクトリを作成
        mkdir -p /tmp/openshift-configs
        
        # BuildConfigを生成（リソース名はプロジェクト内で一意なので変更不要、イメージ名のみ変更）
        sed -e "s|booking-management-system|${PROJECT_NAME}|g" \
            openshift/build-config.yaml > /tmp/openshift-configs/build-config.yaml
        
        # Backend Deploymentを生成
        sed -e "s|booking-management-system|${PROJECT_NAME}|g" \
            openshift/backend-deployment.yaml > /tmp/openshift-configs/backend-deployment.yaml
        
        # Frontend Deploymentを生成
        sed -e "s|booking-management-system|${PROJECT_NAME}|g" \
            openshift/frontend-deployment.yaml > /tmp/openshift-configs/frontend-deployment.yaml
        
        # Routeを生成（リソース名は変更不要）
        cp openshift/route.yaml /tmp/openshift-configs/route.yaml
        
        echo "Generated OpenShift configurations for project: $PROJECT_NAME"

    - name: Apply OpenShift configurations
      run: |
        oc apply -f /tmp/openshift-configs/build-config.yaml
        oc apply -f /tmp/openshift-configs/backend-deployment.yaml
        oc apply -f /tmp/openshift-configs/frontend-deployment.yaml
        oc apply -f /tmp/openshift-configs/route.yaml

    - name: Build and deploy backend
      working-directory: ./backend
      run: |
        oc start-build booking-backend --from-dir=. --wait --follow
        echo "Backend build completed"

    - name: Build and deploy frontend
      working-directory: ./frontend
      run: |
        oc start-build booking-frontend --from-dir=. --wait --follow
        echo "Frontend build completed"

    - name: Verify ImageStream tags
      run: |
        echo "Verifying ImageStream tags are available..."
        # oc start-build --waitでビルド完了を待っているので、ImageStreamTagもすぐに利用可能になるはず
        # 短い待機時間で確認（最大10秒、1秒間隔）
        timeout 10 bash -c 'until oc get imagestreamtag booking-backend:latest > /dev/null 2>&1; do echo "Waiting for booking-backend:latest..."; sleep 1; done' || echo "Warning: booking-backend:latest not found yet"
        timeout 10 bash -c 'until oc get imagestreamtag booking-frontend:latest > /dev/null 2>&1; do echo "Waiting for booking-frontend:latest..."; sleep 1; done' || echo "Warning: booking-frontend:latest not found yet"
        echo "ImageStream tags verification completed"
        oc get imagestreamtags || true

    - name: Trigger deployment update
      run: |
        echo "Triggering deployment updates..."
        # デプロイメントを手動でロールアウトして新しいイメージを使用させる
        oc rollout restart deployment/booking-backend || true
        oc rollout restart deployment/booking-frontend || true
        echo "Deployment restarts triggered"

    - name: Check deployment status
      run: |
        echo "Checking deployment status..."
        oc get deployments
        oc get pods -l app=booking-backend
        oc get pods -l app=booking-frontend

    - name: Wait for deployments
      run: |
        echo "Waiting for deployments to be ready..."
        # タイムアウトを10分に延長
        oc rollout status deployment/booking-backend --timeout=10m || {
          echo "Backend deployment failed. Checking logs..."
          oc get pods -l app=booking-backend
          oc describe deployment/booking-backend
          oc logs -l app=booking-backend --tail=50 || true
          exit 1
        }
        oc rollout status deployment/booking-frontend --timeout=10m || {
          echo "Frontend deployment failed. Checking logs..."
          oc get pods -l app=booking-frontend
          oc describe deployment/booking-frontend
          oc logs -l app=booking-frontend --tail=50 || true
          exit 1
        }
        echo "All deployments are ready!"

    - name: Get application URL
      run: |
        PROJECT_NAME="${{ steps.team.outputs.project_name }}"
        TEAM_ID="${{ steps.team.outputs.team_id }}"
        echo "=========================================="
        echo "Deployment completed!"
        echo "Team ID: $TEAM_ID"
        echo "OpenShift Project: $PROJECT_NAME"
        echo "Application URL:"
        oc get route booking-frontend -o jsonpath='{.spec.host}' || echo "Route not found"
        echo ""
        echo "=========================================="


