name: Deploy to OpenShift

on:
  push:
    branches:
      - main
      - sandbox
  workflow_dispatch:

env:
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  OPENSHIFT_PROJECT: booking-management-system

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Build backend
      working-directory: ./backend
      run: mvn clean package -DskipTests

    - name: Build frontend
      working-directory: ./frontend
      run: |
        # npm ciのバグでオプショナル依存関係がインストールされない場合があるため、
        # npm installを使用（package-lock.jsonは保持）
        npm install
        npm run build

    - name: Install OpenShift CLI
      run: |
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | tar -xz
        sudo mv oc kubectl /usr/local/bin/

    - name: Login to OpenShift
      run: |
        oc login --server=${{ env.OPENSHIFT_SERVER }} --token=${{ env.OPENSHIFT_TOKEN }} --insecure-skip-tls-verify=true

    - name: Create or select project
      run: |
        if oc get project ${{ env.OPENSHIFT_PROJECT }} > /dev/null 2>&1; then
          oc project ${{ env.OPENSHIFT_PROJECT }}
        else
          oc new-project ${{ env.OPENSHIFT_PROJECT }}
        fi

    - name: Apply OpenShift configurations
      working-directory: ./openshift
      run: |
        oc apply -f build-config.yaml
        oc apply -f backend-deployment.yaml
        oc apply -f frontend-deployment.yaml
        oc apply -f route.yaml

    - name: Build and deploy backend
      working-directory: ./backend
      run: |
        oc start-build booking-backend --from-dir=. --wait --follow
        echo "Backend build completed"

    - name: Build and deploy frontend
      working-directory: ./frontend
      run: |
        oc start-build booking-frontend --from-dir=. --wait --follow
        echo "Frontend build completed"

    - name: Wait for ImageStreams to be ready
      run: |
        echo "Waiting for ImageStreams to be ready..."
        oc wait --for=condition=ready imagestream/booking-backend --timeout=2m || true
        oc wait --for=condition=ready imagestream/booking-frontend --timeout=2m || true
        echo "ImageStreams ready"

    - name: Wait for ImageStream tags
      run: |
        echo "Waiting for ImageStream tags to be available..."
        # ImageStreamTagが利用可能になるまで待機
        timeout 300 bash -c 'until oc get imagestreamtag booking-backend:latest > /dev/null 2>&1; do echo "Waiting for booking-backend:latest..."; sleep 5; done' || true
        timeout 300 bash -c 'until oc get imagestreamtag booking-frontend:latest > /dev/null 2>&1; do echo "Waiting for booking-frontend:latest..."; sleep 5; done' || true
        echo "ImageStream tags are available"
        oc get imagestreamtags

    - name: Trigger deployment update
      run: |
        echo "Triggering deployment updates..."
        # デプロイメントを手動でロールアウトして新しいイメージを使用させる
        oc rollout restart deployment/booking-backend || true
        oc rollout restart deployment/booking-frontend || true
        echo "Deployment restarts triggered"

    - name: Check deployment status
      run: |
        echo "Checking deployment status..."
        oc get deployments
        oc get pods -l app=booking-backend
        oc get pods -l app=booking-frontend

    - name: Wait for deployments
      run: |
        echo "Waiting for deployments to be ready..."
        # タイムアウトを10分に延長
        oc rollout status deployment/booking-backend --timeout=10m || {
          echo "Backend deployment failed. Checking logs..."
          oc get pods -l app=booking-backend
          oc describe deployment/booking-backend
          oc logs -l app=booking-backend --tail=50 || true
          exit 1
        }
        oc rollout status deployment/booking-frontend --timeout=10m || {
          echo "Frontend deployment failed. Checking logs..."
          oc get pods -l app=booking-frontend
          oc describe deployment/booking-frontend
          oc logs -l app=booking-frontend --tail=50 || true
          exit 1
        }
        echo "All deployments are ready!"

    - name: Get application URL
      run: |
        echo "Application URL:"
        oc get route booking-frontend -o jsonpath='{.spec.host}'
        echo ""


